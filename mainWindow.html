<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Philips Dutch Tech Week</title>
        <script>window.$ = window.jQuery = require('jquery');</script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/waypoints/2.0.3/waypoints.min.js"></script>
        <script src="jquery.counterup.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
            crossorigin="anonymous">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
    </head>
        
    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-12">
                    <div id="successAlert" class="alert alert-success collapse" role="alert"></div>
                </div>
                
            </div>
            <div class="row">
                <div id="player1" class="col-sm-4 border border-dark">
                    <h1 class="display-3">Player 1</h1>
                    <div id="bpmPlayer1">
                        <span id="p1Bpm">0 bpm</span>
                    </div>
                    <div id="spo2Player1">
                        <span id="p1Spo2">0%</span>
                    </div>
                </div>
                <div class="col-sm-4">
                    <span id="counter">0</span>
                </div>
                <div id="player2" class="col-sm-4 border border-dark">
                    <h1 class="display-3">Player 2</h1>
                    <div id="bpmPlayer2">
                        <span id="p2Bpm" >0 bpm</span>
                    </div>
                    <div id="spo2Player2">
                        <span id="p2Spo2">0%</span>
                    </div>
                </div>
            </div>
            
            <div class="row"></div>
                <div class="mx-auto" style="width: 200px;">
                    <span id="chronometer" style="font-size:2rem;" class="badge badge-pill badge-warning">00:00:00</span>
                </div>
            </div>
            
            <div class="row">
                <div class="col-sm-10 ">
                    <button id="startButton" type="button" value="Start" class="btn btn-success btn-lg btn-block" onclick="startNewGame()">Start Game</button>
                    <button id="stopButton" type="button" value="Stop" class="btn btn-secondary btn-lg btn-block" style="display: none" onclick="stopGame()">Stop Game</button>
                </div>
            </div>
        </div>

        <script>
            const electron = require('electron');
            const { ipcRenderer } = electron;
            const EasyTimer = require('easytimer.js');
            const players = ['p1', 'p2'];
            let timer = new EasyTimer();

            function startNewGame() {
                console.log("Starting a new game....");
                $("#startButton").hide();
                $("#stopButton").show();
                $('#successAlert').hide();

                players.forEach((player) => {
                    $('#' + player + 'Bpm').text("0 bpm");
                    $('#' + player + 'Spo2').text("0%");
                });

                ipcRenderer.send('game:start', {});
                startChronometer();
            }

            function stopGame() {
                console.log("Stoping the countercountergame...");
                $('#successAlert').text("The game was interrupted!!!");
                $('#successAlert').show();

                $('#startButton').show();
                $('#stopButton').hide();

                stopChronometer();
                ipcRenderer.send('game:stop', {});
            }

            function startChronometer() {
                console.log('starting the chronometer...');
                timer.reset();
                timer.start({ precision: 'seconds' });
                timer.addEventListener('secondsUpdated', function (e) {
                    $('#chronometer').html(timer.getTimeValues().toString());
                });
            }

            function stopChronometer() {
                console.log('stoping the chronometer...');
                timer.stop();
            }

            ipcRenderer.on('game:over', (event, data) => {
                 $('#successAlert').fadeIn(2000, () => {
                    $('#successAlert').text("The game is finished!!!");
                    $('#successAlert').show();
                });

                stopChronometer()

                $("#counter").fadeOut(1000, () => {
                    $(this).text("stopped").fadeIn(1000);
                });
            });
            
            ipcRenderer.on('screen:update', (event, data) => {
                if (data !== undefined && data.length > 0) {
                    data.forEach((el) => {
                        const player = (el.playerID === "1") ? 'p1' : 'p2';
                        $('#'+player+'Bpm').text(el.data.bpm);
                        $('#'+player+'Spo2').text(el.data.spo2);
                    });
                }
            });

            ipcRenderer.on('screen:countdown', (event, data) => {
                if (data !== undefined) {
                    $("#counter").fadeOut(1000, () => {
                        $(this).text(data).fadeIn(1000);
                    });
                }
            });
        </script>
    </body>
</html>